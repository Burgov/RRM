"use strict";var ObjectManager=function(t){this.proxyFactory=t||new ProxyFactory;var e=this,r={},o={};this.register=function(t){o[t.prototype.$name]=t};var n=function(t,e){r[t]=r[t]||[],r[t].indexOf(e)<0&&r[t].push(e)},a=function(t,e){if(void 0===e)return null;if(!(t in r))return null;var o=r[t];for(var n in o)if(o[n].id==e)return o[n];return null},i=function(t,r){var o=t.$schema[r];if(!("transform"in o))throw Error("transform is mandatory");var n={};o.readable&&(n.get=function(){if(!(r in t.$values))throw new Error("The property '"+r+"' was not initialized");return t.$values[r]}),o.writable&&(n.set=function(n){if(!(r in t.$values))throw new Error("The property '"+r+"' was not initialized");t.$dirty=!0,t.$values[r]=o.transform(n,e,t)}),n.enumerable=!0,Object.defineProperty(t,r,n)};this.loadPropertyValue=function(t,e,r){var o=t.$schema[e];t.$raw[e]=r,this.setPropertyValue(t,e,o.transform(r,this,t))},this.setPropertyValue=function(t,e,r){return this.isProxy(t)&&!t.isLoaded()?void(t[e]=r):void(t.$values[e]=r)},this.update=function(t,r){for(var o in t.$schema)delete t.$raw[o],delete t.$values[o];for(var o in r)e.loadPropertyValue(t,o,r[o])},this.isProxy=function(t){return t instanceof e.proxyFactory.getProxyClass(o[t.$name])},this.create=function(t,r){var p=function(a){var p=Object.create(o[t].prototype,{$values:{value:{}},$raw:{value:{}},$dirty:{value:!1,writable:!0}});a&&n(t,p),r=r||{};for(var s in p.$schema)i(p,s);for(var s in r)e.loadPropertyValue(p,s,r[s]);return o[t].constructor.call(p),p},s=a(t,r.id);if(null!==s){if(!this.isProxy(s))return this.update(s,r),s;var R=p(!1);return s.object=R,o[t].constructor.call(s),s}var R=p(!0);return R},this.get=function(t,e){var r=a(t,e);if(null===r)throw Error("not loaded");return r},this.getAll=function(t){return r[t]||{}},this.toArray=function(t){var e={},r=[];for(var o in t.$schema)if(t.$schema[o].persistable)try{e[o]=t.$schema[o].reverseTransform(t[o],this)}catch(n){if(n.message!="The property '"+o+"' was not initialized")throw n;r.push(o)}if(r.length)throw new Error("Cannot call toArray() on an entity that is not fully initialized. Uninitialized properties: "+r.join(", "));return e},this.getReference=function(t,e){var r;return r=a(t,e),null===r&&(r=this.createProxy(t,e)),r},this.createProxy=function(t,e){var r=this.proxyFactory.createProxy(o[t],e);return n(t,r),r}};Object.defineProperty(ObjectManager,"prepareEntity",{value:function(t,e,r){Object.defineProperty(e.prototype,"$name",{value:t}),Object.defineProperty(e.prototype,"$schema",{value:new r})}});var RRM=RRM||{};RRM.Property=RRM.Property||{},RRM.Relation=RRM.Relation||{},RRM.Property.Base=function(t,e){e=e||{},this.readable="readable"in e?e.readable:!0,this.writable="writable"in e?e.writable:!0,this.loadable="loadable"in e?e.loadable:!0,this.persistable="persistable"in e?e.persistable:!0},Object.defineProperty(RRM.Property.Base.prototype,"transform",{value:function(t){return t}}),Object.defineProperty(RRM.Property.Base.prototype,"reverseTransform",{value:function(t){return t}}),RRM.Property.Int=function(){RRM.Property.Base.apply(this,arguments)},RRM.Property.Int.prototype=Object.create(RRM.Property.Base.prototype),RRM.Property.Int.prototype.constructor=RRM.Property.Int,Object.defineProperty(RRM.Property.Int.prototype,"transform",{value:function(t){return parseInt(RRM.Property.Base.prototype.transform.call(this,t),10)}}),RRM.Property.String=function(){RRM.Property.Base.apply(this,arguments)},RRM.Property.String.prototype=Object.create(RRM.Property.Base.prototype),RRM.Property.String.prototype.constructor=RRM.Property.String,Object.defineProperty(RRM.Property.String.prototype,"transform",{value:function(t){return t=RRM.Property.Base.prototype.transform.call(this,t),void 0===t||null===t?null:t+""}}),RRM.Property.Boolean=function(){RRM.Property.Base.apply(this,arguments)},RRM.Property.Boolean.prototype=Object.create(RRM.Property.Base.prototype),RRM.Property.Boolean.prototype.constructor=RRM.Property.Boolean,Object.defineProperty(RRM.Property.Boolean.prototype,"transform",{value:function(t){return!!RRM.Property.Base.prototype.transform.call(this,t)}}),RRM.Property.Array=function(){RRM.Property.Base.call(this,arguments)},RRM.Property.Array.prototype=Object.create(RRM.Property.Base.prototype),RRM.Property.Array.prototype.constructor=RRM.Property.Array,Object.defineProperty(RRM.Property.Array.prototype,"transform",{value:function(t){if(t instanceof Array)return t;if(t instanceof Object){var e=[],r=Object.getOwnPropertyNames(t);for(var o in r)e.push(t[r[o]]);return e}throw Error("Only Arrays and Objects are supported")}}),RRM.Property.Object=function(){RRM.Property.Base.apply(this,arguments)},RRM.Property.Object.prototype=Object.create(RRM.Property.Base.prototype),RRM.Property.Object.prototype.constructor=RRM.Property.Object,RRM.Property.Date=function(){RRM.Property.Base.apply(this,arguments)},RRM.Property.Date.prototype=Object.create(RRM.Property.Base.prototype),RRM.Property.Date.prototype.constructor=RRM.Property.Date,Object.defineProperty(RRM.Property.Date.prototype,"transform",{value:function(t){return new Date(RRM.Property.Base.prototype.transform(t))}}),RRM.Relation.Base=function(t,e){this.entityClass=e.entityClass,RRM.Property.Base.apply(this,arguments)},RRM.Relation.Base.prototype=Object.create(RRM.Property.Base.prototype),RRM.Relation.Base.prototype.constructor=RRM.Relation.Base,RRM.Relation.ManyToOne=function(){RRM.Relation.Base.apply(this,arguments)},RRM.Relation.ManyToOne.prototype=Object.create(RRM.Relation.Base.prototype),RRM.Relation.ManyToOne.prototype.constructor=RRM.Relation.ManyToOne,Object.defineProperties(RRM.Relation.ManyToOne.prototype,{transform:{value:function(t,e){return void 0===t||null===t?null:t instanceof Object?e.create(this.entityClass,t):e.getReference(this.entityClass,t)}},reverseTransform:{value:function(t){return t?t.id:null}}}),RRM.Relation.ManyToMany=function(){RRM.Relation.Base.apply(this,arguments)},RRM.Relation.ManyToMany.prototype=Object.create(RRM.Relation.Base.prototype),RRM.Relation.ManyToMany.prototype.constructor=RRM.Relation.ManyToMany,Object.defineProperties(RRM.Relation.ManyToMany.prototype,{transform:{value:function(t,e){var r=this;return t.map(function(t){return RRM.Relation.ManyToOne.prototype.transform.call(r,t,e)})}},reverseTransform:{value:function(t,e){var r=this;return t.map(function(t){return RRM.Relation.ManyToOne.prototype.reverseTransform.call(r,t,e)})}}}),RRM.Relation.OneToMany=function(t,e){RRM.Relation.Base.apply(this,arguments),this.backReference=e.backReference||null},RRM.Relation.OneToMany.prototype=Object.create(RRM.Relation.Base.prototype),RRM.Relation.OneToMany.prototype.constructor=RRM.Relation.OneToMany,Object.defineProperties(RRM.Relation.OneToMany.prototype,{transform:{value:function(t,e,r){var o=[];for(var n in t){var a;a=t[n]instanceof Object?e.create(this.entityClass,t[n]):e.getReference(this.entityClass,t[n]),o.push(a),this.backReference&&e.setPropertyValue(a,this.backReference,r)}return o}},reverseTransform:{value:function(t,e){return t.map(function(t){return e.toArray(t)})}}}),RRM.Relation.OneToOne=function(){RRM.Relation.Base.apply(this,arguments)},RRM.Relation.OneToOne.prototype=Object.create(RRM.Relation.Base.prototype),RRM.Relation.OneToOne.prototype.constructor=RRM.Relation.OneToOne,Object.defineProperties(RRM.Relation.OneToOne.prototype,{transform:{value:function(t,e){return this.entityClass?e.create(this.entityClass,t):t}},reverseTransform:{value:function(t,e){return t?e.toArray(t):void 0}}});var ProxyFactory=function(){var t={},e=function(t){var e=function(e){this.object=void 0;var r=this;this.isLoaded=function(){return void 0!==this.object},this.load=function(){if(void 0===this.object)throw Error("Entity cannot be loaded")},this.addProperty=function(t){Object.defineProperty(this,t,{get:function(){return r.load(),r.object[t]},set:function(e){r.load(),r.object[t]=e},enumerable:!0})};for(var o in t.prototype.$schema)"id"!=o&&this.addProperty(o);Object.defineProperty(this,"id",{get:function(){return e},enumerable:!0}),t.call(this)};return e.prototype=Object.create(t.prototype),e.constructor=e,e};this.getProxyClass=function(r){return r.$name+"Proxy"in t||(t[r.$name+"Proxy"]=e(r)),t[r.$name+"Proxy"]},this.createProxy=function(t,e){var r=this.getProxyClass(t);return new r(e)}};