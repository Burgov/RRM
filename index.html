<!DOCTYPE html>
<html>
<head>
    <title></title>
    <script>
        "use strict";
        var Entity = function() {}
        Object.defineProperty(Entity.prototype, '$values', {
            value: {}
        });
        Object.defineProperty(Entity.prototype, '$dirty', {
            value: false,
            writable: true
        });

        var ProjectSchema = function() {
            this.id = {
                get: function() {
                    return this.$values.id;
                },
                transform: function(json) {
                    return json.id;
                }
            }
            this.age = {
                get: function() {
                    return this.$values.age;
                },
                transform: function(json) {
                    var date = new Date(json.created_at);
                    var age = 0;
                    while(date < new Date()) {
                        age++;
                        date.setFullYear(date.getFullYear() + 1);
                    }
                    return age;
                }
            }
            this.name = {
                get: function() {
                    return this.$values.name;
                },
                set: function(value) {
                    this.$values.name = value;
                },
                transform: function(json) {
                    return json.name;
                },
                reverseTransform: function(json) {
                    json.name = this.name;
                }
            }
            this.description = {
                get: function() {
                    return this.$values.description;
                },
                set: function(value) {
                    this.$values.description = value;
                },
                transform: function(json) {
                    return json.description;
                },
                reverseTransform: function(json) {
                    json.description = this.description;
                }
            }
        };
        var projectSchema = new ProjectSchema();

        var Project = function() {}
        Project.prototype = Entity.prototype;


        var RRM = function() {
            var defineProperty = function(entity, name, property, data) {
                if (!('transform' in property)) {
                    throw Error('transform is mandatory');
                }
                var value = property.transform(data);
                entity.$values[name] = value;

                var definition = {};
                if ('get' in property) {
                    definition.get = function() {
                        return property.get.call(entity);
                    }
                }
                if ('set' in property) {
                    definition.set = function(value) {
                        entity.$dirty = true;
                        return property.set.call(entity, value);
                    }
                }

                Object.defineProperty(entity, name, definition);
            };

            this.create = function(entityClass, data) {
                var entity = new entityClass;

                for (var i in projectSchema) {
                    defineProperty(entity, i, projectSchema[i], data);
                }

                return entity;
            };

            this.save = function(entity) {
                var data = {};

                for (var i in projectSchema) {
                    var property = projectSchema[i];
                    if (!('reverseTransform' in property)) {
                        continue;
                    }

                    property.reverseTransform.call(entity, data);
                }
                entity.$dirty = false;

                console.log(data);
            };
        }

        var rrm = new RRM;

        var project = rrm.create(Project, { id: 1, name: 'Project', description: 'This is the description', created_at: '2010-05-16T00:00:00Z' });

        console.log("id: " + project.id + ", name: " + project.name + ', description: '+ project.description +', age:' + project.age);
        console.log(project.$dirty);
        try {
            project.id = 2;
        } catch (e) {
        } finally {
            console.log(project.$dirty);
        }
        project.name = "other project";
        console.log(project.$dirty);
        rrm.save(project);
        console.log(project.$dirty);
    </script>
</head>
<body>

</body>
</html>